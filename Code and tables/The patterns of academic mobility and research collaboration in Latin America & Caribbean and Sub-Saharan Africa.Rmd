---
title: "The patterns of academic mobility and research collaboration in Latin America
  & Caribbean and Sub-Saharan Africa"
author: "Huilin Ge"
date: "2025-09-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# ----------------------------
# 0. Load required packages
# ----------------------------

library("geosphere")
library("pracma")
library("dplyr")
library("pracma")
library("ggplot2")
library("sf")
library("tidyr")
library("ggrepel")
library("MASS")
library("networkD3")
library("gridExtra")
library("htmltools")
library("ggalluvial")
library("ineq")
library("grid")
library("png")
library("magick")
library("ggrepel")
library("gtable")

```

```{r}
# ----------------------------
# 1. Publications & researchers by year (LAC vs SSA)
# ----------------------------


# Read aggregated counts by region and year

pub_researcher_year<-read.csv("pub and reseracher per region by year.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")


# Convert wide format (n_pub, n_researcher) to long format for ggplot

pub_researcher_year_long <- pub_researcher_year %>%
  pivot_longer(cols = c(n_pub, n_researcher), names_to = "variable", values_to = "value")

# Create a combined category for legend mapping (region + variable)

pub_researcher_year_long$variable_abbr_region<-paste(pub_researcher_year_long$abbr_region, pub_researcher_year_long$variable, sep = "_")


# Set factor levels to control legend / bar order

pub_researcher_year_long$variable_abbr_region = factor(pub_researcher_year_long$variable_abbr_region,
                                levels = c("LAC_n_pub",  "SSA_n_pub", "LAC_n_researcher","SSA_n_researcher"))

```

```{r}
# ----------------------------
# 1.1 Plot: publications & researchers (bars) + avg pubs per researcher (points)
# ----------------------------

# Save plot as PNG

png(file="STS1--pub_researcher_region_year.png", width=3000, height=1500)

ggplot(pub_researcher_year_long, aes(x = pub_year)) +
  
    # Bars: total publications and total researchers (dodged)

  geom_bar(aes(y = value, fill = variable_abbr_region), stat = "identity", position = position_dodge(width = 0.8)) +
  
    # Points: average publications per researcher (scaled to match left axis)
  
  geom_point(data = pub_researcher_year, aes(x = pub_year, y = ave_pub_researcher * 300000, color = abbr_region), size = 10, shape = 23, stroke = 5) +
  
    # Manual colors and legend labels for bars

  scale_fill_manual(values = c("LAC_n_pub" = "#d62728", 
                               "SSA_n_pub" = "#1f77b4",
                               "LAC_n_researcher" = "#f28b8c", 
                               "SSA_n_researcher" = "#aec7e8"),
                    labels=c("LAC_n_pub" = "LAC-N. Publications", 
                              "SSA_n_pub" = "SSA-N. Publications", 
                              "LAC_n_researcher" = "LAC-N. Researchers",
                              "SSA_n_researcher" = "SSA-N. Researchers")) +
  
    # Manual colors and legend labels for points

    scale_color_manual(values = c("LAC" = "#d62728", "SSA" = "#1f77b4")
                       ,labels = c("LAC" = "LAC-Avg. Publications/Researchers",
                                   "SSA" = "SSA-Avg. Publications/Researchers" )) +
  
    # Left axis: counts; Right axis: average publications per researcher (undo scaling)
  
  scale_y_continuous(
    name = "Number of publication and researchers", 
    limits = c(0, 305000), 
    expand = c(0, 0), 
    breaks = seq(0,300000,50000),
    labels = scales::comma,
    sec.axis = sec_axis(~./300000, 
                        breaks = seq(0, 1, 0.1), 
                        name = "Average number of publication per researcher")) +
  
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Year") +
  guides(
      fill = guide_legend(title = NULL, order=1,nrow =2),
    color = guide_legend(title = NULL,order=2, nrow = 2),nrow=2) + 
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "gray",size=1),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(), 
    plot.title = element_text(hjust = 0.5, size = 40),
    axis.ticks = element_line(size = 1.5), 
    axis.ticks.length = unit(0.5, "cm"),
    axis.line = element_line(size = 1.5), 
    axis.text = element_text(size = 40),
    axis.title = element_text(size = 40),
    axis.title.x = element_text(size = 40, margin = margin(20, 0, 0, 0)),
    axis.title.y = element_text(size = 40, margin = margin(0, 20, 0, 0)),
    axis.title.y.right = element_text(margin = margin(l = 20)),
    legend.text = element_text(size = 40),
    legend.title = element_text(size = 40),
    legend.position ="bottom"
  )

dev.off()
```


```{r}
# ----------------------------
# 2. Inequality (Gini) across countries within each region
# ----------------------------

# Read country-level totals (and ranks) within regions

pub_researcher_country<-read.csv("total number of pub and researchers per country  and its rank in region.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Compute Gini for publications and researchers within each region

gini_n_pub_researcher_region <- pub_researcher_country %>%
  group_by(abbr_region) %>%
  summarise(
    gini_pub = ineq::Gini(n_pub_country),
    gini_researcher = ineq::Gini(n_researcher_country)
  )

gini_n_pub_researcher_region

```


```{r}
# ----------------------------
# 3. Mobility time series for LAC: counts and proportions (long format)
# ----------------------------

# Read mobility data for LAC

mobility_year_LAC<-read.csv("mobility_year_LAC.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Long format for number of mobile researchers

mobi_num_LAC  <- mobility_year_LAC %>%
  transmute(year_mobility, direction, region,
            metric = "Number of international mobile researchers", 
            value = n_mobile)

# Set region order in the legend/plot

mobi_num_LAC$region<- factor(mobi_num_LAC$region,
                             levels=c("LAC","EAP", "ECA", "MENA" ,"NA" ,"SA","SSA" ))

# Long format for proportion mobile

mobi_prop_LAC <- mobility_year_LAC %>%
  transmute(year_mobility, direction, region,
            metric = "Proportion of international mobile researchers", 
            value = prop_mobile)

# Combine (not used in the plot below, but useful for faceting later)

mobi_all_LAC <- bind_rows(mobi_num_LAC, mobi_prop_LAC)

```


```{r}
# ----------------------------
# 3.1 Plot: mobility flows for LAC (counts)
# ----------------------------

# Define region color palette

region_cols <- c(
  "EAP"="#1f77b4","ECA"="#ff7f0e","LAC"="#2ca02c","MENA"="#d62728",
  "NA"="#9467bd","SA"="#8c564b","SSA"="#e377c2"
)


png(file = "STS 2--mobility_LAC.png", width = 3000, height = 2000)

ggplot(mobi_num_LAC  , aes(
                   x = factor(year_mobility),
                   y = value,
                   color = region,
                   group = region)) +
  geom_line(size = 3) +
    # Facet by direction (from/to) and metric

 facet_grid(
   rows=vars(metric),
   cols = vars(direction),
   scales = "free_y",
   labeller = labeller(
     direction = c(
      "From LAC"  = "From Latin America & Caribbean",
      "To LAC"   = "To Latin America & Caribbean"
    ) ),
  switch = "y"   ) +
  
  # Color mapping and human-readable region names
  
  scale_color_manual(values = region_cols,
                     labels=c( "EAP" = "East Asia & Pacific",
                               "ECA" = "Europe & Central Asia",
                               "LAC"  = "Intra-LAC",
                               "MENA" = "Middle East & North Africa",
                               "NA" = "North America",
                               "SA" = "South Asia",
                               "SSA" = "SSA")) +
  
    # Show only key years on x-axis

  scale_x_discrete(breaks = c("1990","2000","2010","2020")) +
  
    # Vertical reference line (e.g., start of COVID period)

  geom_vline(xintercept = "2020", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 40), 
    axis.text.y = element_text(size = 40),
    axis.title.x = element_text(size = 60),
    axis.title.y = element_text(size = 60),
    panel.grid.major =  element_line(color = "grey80"), 
    panel.grid.minor = element_blank(),  
    plot.title = element_blank(),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),   
    legend.key.size = unit(3, "cm") ,
    strip.placement = "outside",
    strip.text.y = element_text(size = 60),
    strip.text.x = element_text(size = 60),
    strip.background = element_blank()
  ) +
  labs(x = "Year of mobility", y = NULL, color = "Region") +
  guides(color = guide_legend(nrow = 2))


dev.off()
```


```{r}
# ----------------------------
# 4. Mobility time series for SSA: counts and proportions (long format)
# ----------------------------

mobility_year_SSA<-read.csv("mobility_year_SSA.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Long format for number of mobile researchers

mobi_num_SSA  <- mobility_year_SSA %>%
  transmute(year_mobility, direction, region,
            metric = "Number of international mobile researchers", 
            value = n_mobile)

# Set legend/plot order

mobi_num_SSA$region<- factor(mobi_num_SSA$region,
                             levels=c("SSA", "EAP", "ECA","LAC", "MENA" ,"NA","SA" ))

# Long format for proportion mobile

mobi_prop_SSA <- mobility_year_SSA %>%
  transmute(year_mobility, direction, region,
            metric = "Proportion of international mobile researchers", 
            value = prop_mobile)

mobi_all_SSA <- bind_rows(mobi_num_SSA, mobi_prop_SSA)

```

```{r}
# ----------------------------
# 4.1 Plot: mobility flows for SSA (counts)
# ----------------------------

region_cols <- c(
  "EAP"="#1f77b4","ECA"="#ff7f0e","LAC"="#2ca02c","MENA"="#d62728",
  "NA"="#9467bd","SA"="#8c564b","SSA"="#e377c2"
)


png(file = "STS 3--mobility_SSA.png", width = 3000, height = 2000)

ggplot(mobi_num_SSA, aes(x = factor(year_mobility),
                   y = value,
                   color = region,
                   group = region)) +
  geom_line(size = 3) +
 facet_grid(
  rows = vars(metric),
  cols = vars(direction),
  scales = "free_y",
  labeller = labeller(
    direction= c(
      "From SSA"   = "From Sub-Saharan Africa",
      "To SSA"   = "To Sub-Saharan Africa"
    )
  ),
  switch = "y"   
) +
  scale_color_manual(values = c(
    "EAP"="#1f77b4","ECA"="#ff7f0e","LAC"="#2ca02c","MENA"="#d62728",
    "NA"="#9467bd","SA"="#8c564b","SSA"="#e377c2"
  ),
  labels=c( "EAP" = "East Asia & Pacific",
               "ECA" = "Europe & Central Asia",
               "LAC"  = "LAC",
               "MENA" = "Middle East & North Africa",
               "NA" = "North America",
               "SA" = "South Asia",
               "SSA" = "Intra-SSA")) +
  scale_x_discrete(breaks = c("1990","2000","2010","2020")) +
  geom_vline(xintercept = "2020", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 40), 
    axis.text.y = element_text(size = 40),
    axis.title.x = element_text(size = 60),
    axis.title.y = element_text(size = 60),
    panel.grid.major =  element_line(color = "grey80"), 
    panel.grid.minor = element_blank(),  
    plot.title = element_blank(),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),   
    legend.key.size = unit(3, "cm") ,
    strip.placement = "outside",
    strip.text.y = element_text(size = 60),
    strip.text.x = element_text(size = 60),
    strip.background = element_blank()
  ) +
  labs(x = "Year of mobility", y = NULL, color = "Region") +
  guides(color = guide_legend(nrow = 2))
dev.off()
```

```{r}
# ----------------------------
# 5. Combine Gephi network images (crop + annotate + stitch)
# ----------------------------

mobility_1 <- image_read("gephi-1.png")
mobility_2 <- image_read("gephi-2.png")
mobility_3 <- image_read("gephi-3.png")
mobility_4 <- image_read("gephi-4.png")


# Disable interpolation to avoid blurring when resizing/cropping

img_1 <- image_resize(mobility_1, geometry = NULL, filter = "point")
img_2 <- image_resize(mobility_2, geometry = NULL, filter = "point")
img_3 <- image_resize(mobility_3, geometry = NULL, filter = "point")
img_4 <- image_resize(mobility_4, geometry = NULL, filter = "point")

# Get original image dimensions

info <- image_info(img_1)
w <- info$width
h <- info$height

# Define pixels to crop from top/bottom (remove margins)

crop_top    <- 120
crop_bottom <- 120
new_height <- h - crop_top - crop_bottom

# Crop each image (slightly different cropping for later panels)

cropped_1 <- image_crop(
  img_1,
  sprintf("%sx%s+0+%s", w, new_height, crop_top),
  repage = FALSE
)
cropped_2 <- image_crop(
  img_2,
  sprintf("%sx%s+0+%s", w, new_height, crop_top),
  repage = FALSE
)
cropped_3 <- image_crop(
  img_3,
  sprintf("%sx%s+0+%s", w, h-150, 80 ),
  repage = FALSE
)
cropped_4 <- image_crop(
  img_4,
  sprintf("%sx%s+0+%s", w,  h-150, 60),
  repage = FALSE
)

# Add time-period labels to each panel

cropped_1 <- image_annotate(cropped_1, "1990-1999", location = "+5+120", size = 60, color = "black")
cropped_2 <- image_annotate(cropped_2, "2000-2009", location = "+5+120", size = 60, color = "black")
cropped_3 <- image_annotate(cropped_3, "2010-2019", location = "+5+70", size = 60, color = "black")
cropped_4 <- image_annotate(cropped_4, "2020-2023", location = "+5+50", size = 60, color = "black")

# Stitch images into a 2x2 grid (vertical stack, then horizontal append)

combined_image <- image_append(c(cropped_1, cropped_3), stack = TRUE)
combined_image <- image_append(c(combined_image, image_append(c(cropped_2, cropped_4), stack = TRUE)))

# Save combined figure

image_write(combined_image , "STS 4--moblity network-combine--SSA-LAC.png")

```



```{r}
# ----------------------------
# 6. Quah "center of gravity" of destination locations (by origin region & year)
# ----------------------------

data_SSA_LAC_destination<-read.csv("mobility_flow_destination_year_long_lati.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")
```


```{r}
# Function to compute weighted center of gravity on the sphere (Quah-style)

calculate_quah <- function(df) {
  earth_radius <- 6371
  
  # Convert lat/lon to radians

  lat_rad <- df$latitude * pi / 180
  lon_rad <- df$longitude * pi / 180

    # Convert spherical coordinates to 3D Cartesian coordinates
  
  x <- earth_radius * cos(lat_rad) * cos(lon_rad)
  y <- earth_radius * cos(lat_rad) * sin(lon_rad)
  z <- earth_radius * sin(lat_rad)
 
    # Weighted average (weights = number of mobile researchers)
 
  x_cog <- sum(df$n_mobile * x) / sum(df$n_mobile)
  y_cog <- sum(df$n_mobile * y) / sum(df$n_mobile)
  z_cog <- sum(df$n_mobile * z) / sum(df$n_mobile)
  
    # Convert back to latitude/longitude

  central_latitude  <- asin(z_cog / earth_radius) * 180 / pi
  central_longitude <- atan2(y_cog, x_cog) * 180 / pi
  
  return(data.frame(center_latitude = central_latitude, center_longitude = central_longitude))
}

# Compute center of gravity by origin region and mobility year

result_quah <- data_SSA_LAC_destination %>%
  group_by(region_origin, year_mobility) %>%
  do(calculate_quah(.))


print(result_quah)

# Colors for the two origin regions

region_colors <- c(
 "Latin America & Caribbean" = "#2ca02c",
  "Sub-Saharan Africa" = "#e377c2"
)

# World map data (remove Antarctica)

world <- map_data("world")

world <- world %>%
  filter(region != "Antarctica")

# Define map extent based on the computed centers (add margins)

lat_range <- range(result_quah$center_latitude, na.rm = TRUE) + c(-10, 10)
lon_range <- range(result_quah$center_longitude, na.rm = TRUE) + c(-10, 10)

# Filter world map to focus on the relevant geographic window

world_filtered <- world %>%
  filter(long >= lon_range[1], long <= lon_range[2], 
         lat >= lat_range[1], lat <= lat_range[2]) 

# Keep only SSA and LAC origins (used in the final plot)

result_quah_SSA_LAC_destination<-result_quah %>% filter(region_origin %in% c("Sub-Saharan Africa","Latin America & Caribbean"))


# Recompute tighter extents for SSA+LAC only

lat_range_SSA_LAC_destination<- range(result_quah_SSA_LAC_destination$center_latitude, na.rm = TRUE) + c(-20, 20)
lon_range_SSA_LAC_destination <- range(result_quah_SSA_LAC_destination$center_longitude, na.rm = TRUE) + c(-30, 30)

world_filtered_SSA_LAC_destination <- world %>%
  filter(long >= lon_range_SSA_LAC_destination[1], long <= lon_range_SSA_LAC_destination[2], 
         lat >= lat_range_SSA_LAC_destination[1], lat <= lat_range_SSA_LAC_destination[2]) 

```



```{r}
# ----------------------------
# 6.1 Plot: trajectory of destination center of gravity (SSA vs LAC)
# ----------------------------


png(file="STS5--quah--SSA--LAC--central of gravity of mobility destinaiton--across region of origin.png", width=2000,height=900)

ggplot() +
  
  # Plot selected anchor years as points

  geom_point(data = result_quah_SSA_LAC_destination %>% 
               filter(year_mobility %in% c(1990,  2000, 2010, 2020, 2023)),  
             aes(x = center_longitude, y = center_latitude, color = region_origin), 
             size = 3) +
  
    # Axis formatting

  scale_x_continuous(
  breaks = seq(-70, 40, by = 10),
  name = "Longitude of destination center of gravity"
) +
scale_y_continuous(
  breaks = seq(10, 50, by = 10),
  limits = c(10, 50),
  name = "Latitude of destination center of gravity"
)+
  
    # Draw the trajectory over time
  
  geom_path(data = result_quah_SSA_LAC_destination, 
            aes(x = center_longitude, y = center_latitude, color = region_origin, group = region_origin), 
            size = 1.5) +
  geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility %in% c(1990, 2000) & region_origin == "Latin America & Caribbean"),
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),
            hjust = 1.5, vjust = 2,
            size = 10,show.legend = FALSE) +
  
    # Add year labels with manual nudges to reduce overlap

  geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility ==2010 & region_origin == "Latin America & Caribbean"), 
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),hjust = 0.5, vjust =3,
             size = 10,show.legend = FALSE) +
    geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility ==2020 & region_origin == "Latin America & Caribbean"), 
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),hjust = 0, vjust = 2,
             size = 10,show.legend = FALSE) +
   geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility ==2023 & region_origin == "Latin America & Caribbean"), 
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),hjust = 0, vjust = -2,
             size = 10,show.legend = FALSE) +
  geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility %in% c(1990, 2000, 2010) & 
region_origin == "Sub-Saharan Africa"), 
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),hjust = 0, vjust =2,
             size = 10,show.legend = FALSE) +
  geom_text_repel(data = result_quah_SSA_LAC_destination %>% filter(year_mobility %in% c(2020, 2023) & 
region_origin == "Sub-Saharan Africa"), 
            aes(x = center_longitude, y = center_latitude, label = year_mobility, color = region_origin),hjust = -0.5, vjust = 0,
             size = 10,show.legend = FALSE) +

  scale_color_manual(values = region_colors,labels=c("Latin America & Caribbean" = "LAC",
  "Sub-Saharan Africa" = "SSA")) +
  labs(x = "Longitude of destination center of gravity",
  y = "Latitude of destination center of gravity") +
  theme_minimal() +
  theme(legend.position = "bottom",  
    legend.title = element_blank(),  
    legend.text = element_text(size = 40),    
    legend.key.size = unit(1, "cm"),
    axis.text = element_text(size = 40),   
    axis.title.x = element_text(size = 40, margin = margin(20, 0, 0, 0)),
    axis.title.y = element_text(size = 40, margin = margin(0, 20, 0, 0)),
    ) 

dev.off()

```



```{r}
# ----------------------------
# 7. Collaboration patterns over time (LAC): by field and partner region
# ----------------------------

# Read collaboration time series for LAC (by field and partner region)

collaboration_region_year_field_LAC<-read.csv("collaboration_region_year_field--LAC.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Set field order (used for faceting and consistent panel layout)

collaboration_region_year_field_LAC$main_field_id<-factor(collaboration_region_year_field_LAC$main_field_id,levels=c(
              "All",
               "1" ,
               "2" ,
               "3" ,
               "4" ,
               "5"  ))

# Set collaboration-type order (legend + line ordering)

collaboration_region_year_field_LAC$co_country_region<-factor(collaboration_region_year_field_LAC$co_country_region,levels=c("Solo","Domestic", "LAC","EAP", "ECA" ,   "MENA" ,  "NA" ,  "SA" , "SSA" ))

```



```{r}
# ----------------------------
# 7.1 Reshape (counts + proportions) and plot collaboration trends for LAC
# ----------------------------

# Long format for number of publications by collaboration type

coll_num_LAC  <- collaboration_region_year_field_LAC %>%
  transmute(year_collaboration, main_field_id, co_country_region,
            metric = "Number of publications", value = n_pub)

# Long format for proportion of publications by collaboration type

coll_prop_LAC <- collaboration_region_year_field_LAC %>%
  transmute(year_collaboration, main_field_id, co_country_region,
            metric = "Proportion of publications", value = prop_coll)

# Combine counts and proportions (for faceting by metric)

coll_all_LAC <- bind_rows(coll_num_LAC, coll_prop_LAC)

# Save plot as PNG

png(file = "STS 6--coll_LAC.png", width = 3000, height = 2000)

ggplot(coll_all_LAC, aes(x = factor(year_collaboration),
                   y = value,
                   color = co_country_region,
                   group = co_country_region)) +
  geom_line(size = 2) +
 facet_grid(
  rows = vars(metric),
  cols = vars(main_field_id),
  scales = "free_y",
  labeller = labeller(
    main_field_id = c(
      "1"   = "Social sciences\nand humanities",
      "2"   = "Biomedical and\nhealth sciences",
      "3"   = "Physical sciences\nand engineering",
      "4"   = "Life and\nearth sciences",
      "5"   = "Mathematics and\ncomputer science",
      "All" = "All"
    )
  ),
  switch = "y"   
) +
  scale_color_manual(values = c(
    "EAP"="#1f77b4",
    "ECA"="#ff7f0e",
    "LAC"="#2ca02c",
    "MENA"="#d62728",
    "NA"="#9467bd",
    "SA"="#8c564b",
    "SSA"="#e377c2",
    "Domestic"="#FBD63C",
    "Solo"="black"
  ),labels=c( 
    
    "EAP" = "LAC-East Asia & Pacific",
               "ECA" = "LAC-Europe & Central Asia",
               "LAC"  = "Intra-LAC",
               "MENA" = "LAC-Middle East & North Africa",
               "NA" = "LAC-North America",
               "SA" = "LAC-South Asia",
               "SSA" = "LAC-SSA")) +
  scale_x_discrete(breaks = c("1990","2000","2010","2020")) +
  geom_vline(xintercept = "2020", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 40), 
    axis.text.y = element_text(size = 40),
    axis.title.x = element_text(size = 40),
    axis.title.y = element_text(size = 40),
    panel.grid.major =  element_line(color = "grey80"), 
    panel.grid.minor = element_blank(),  
    plot.title = element_blank(),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),   
    legend.key.size = unit(3, "cm") ,
    strip.placement = "outside",
    strip.text.y = element_text(size = 50),
    strip.text.x = element_text(size = 50),
    strip.background = element_blank()
  ) +
  labs(x = "Year", y = NULL, color = "Type of collaboration") +
  guides(color = guide_legend(nrow = 3))
dev.off()
```


```{r}
# ----------------------------
# 8. Collaboration patterns over time (SSA): by field and partner region
# ----------------------------

# Read collaboration time series for SSA (by field and partner region)

collaboration_region_year_field_SSA<-read.csv("collaboration_region_year_field--SSA.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Set field order for faceting

collaboration_region_year_field_SSA$main_field_id<-factor(collaboration_region_year_field_SSA$main_field_id,levels=c(
              "All",
               "1" ,
               "2" ,
               "3" ,
               "4" ,
               "5"  ))

# Set collaboration-type order (legend + line ordering)

collaboration_region_year_field_SSA$co_country_region<-factor(collaboration_region_year_field_SSA$co_country_region,levels=c("Solo","Domestic", "SSA","EAP", "ECA" ,  "LAC",  "MENA" ,  "NA" ,  "SA" ))

```



```{r}
# ----------------------------
# 8.1 Reshape (counts + proportions) and plot collaboration trends for SSA
# ----------------------------

# Long format for number of publications

coll_num_SSA  <- collaboration_region_year_field_SSA %>%
  transmute(year_collaboration, main_field_id, co_country_region,
            metric = "Number of publications", value = n_pub)

# Long format for proportion of publications

coll_prop_SSA <- collaboration_region_year_field_SSA %>%
  transmute(year_collaboration, main_field_id, co_country_region,
            metric = "Proportion of publications", value = prop_coll)

# Combine counts and proportions (for faceting by metric)

coll_all_SSA <- bind_rows(coll_num_SSA, coll_prop_SSA)

# Save plot as PNG

png(file = "STS 7--coll_SSA.png", width = 3000, height = 2000)

ggplot(coll_all_SSA, aes(x = factor(year_collaboration),
                   y = value,
                   color = co_country_region,
                   group = co_country_region)) +
  geom_line(size = 2) +
 facet_grid(
  rows = vars(metric),
  cols = vars(main_field_id),
  scales = "free_y",
  labeller = labeller(
    main_field_id = c(
      "1"   = "Social sciences\nand humanities",
      "2"   = "Biomedical and\nhealth sciences",
      "3"   = "Physical sciences\nand engineering",
      "4"   = "Life and\nearth sciences",
      "5"   = "Mathematics and\ncomputer science",
      "All" = "All"
    )
  ),
  switch = "y") +
  scale_color_manual(values = c("EAP"="#1f77b4","ECA"="#ff7f0e","LAC"="#2ca02c",
                                "MENA"="#d62728","NA"="#9467bd","SA"="#8c564b",
                                "SSA"="#e377c2","Domestic"="#FBD63C","Solo"="black"),
    labels=c( "EAP" = "SSA-East Asia & Pacific",
               "ECA" = "SSA-Europe & Central Asia",
               "LAC"  = "SSA-LAC",
               "MENA" = "SSA-Middle East & North Africa",
               "NA" = "SSA-North America",
               "SA" = "SSA-South Asia",
               "SSA" = "Intra-SSA")) +

  scale_x_discrete(breaks = c("1990","2000","2010","2020")) +
  geom_vline(xintercept = "2020", linetype = "dashed", size = 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 40), 
    axis.text.y = element_text(size = 40),
    axis.title.x = element_text(size = 40),
    axis.title.y = element_text(size = 40),
    panel.grid.major =  element_line(color = "grey80"), 
    panel.grid.minor = element_blank(),  
    plot.title = element_blank(),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),   
    legend.key.size = unit(3, "cm") ,
    strip.placement = "outside",
    strip.text.y = element_text(size = 50),
    strip.text.x = element_text(size = 50),
    strip.background = element_blank()
  ) +
  labs(x = "Year", y = NULL, color = "Type of collaboration") +
  guides(color = guide_legend(nrow = 3))
dev.off()

```


```{r}
# ----------------------------
# 9. Authorship positions (SSA): first vs last author shares by partner region
# ----------------------------

# Read annual shares of first/last authorship in cross-region collaborations (SSA)

n_first_last_SSA<-read.csv("percent of first and last authorship when collaborate with other regions--SSA.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "" )

# Reshape to long format: one row per (year, region, position)

n_first_last_SSA_long <- n_first_last_SSA %>%
  pivot_longer(
    cols = c(prop_first_pub_region_year, prop_last_pub_region_year),
    names_to  = "position",
    values_to = "prop"
  ) %>%
  mutate(
        # Rename variables to readable panel titles
    
    position = recode(
      position,
      prop_first_pub_region_year = "1st authorship position",
      prop_last_pub_region_year  = "Last authorship position"
    )
  )

# Set region order (legend + plotting order)

n_first_last_SSA_long$abbr_region<-factor(
  n_first_last_SSA_long$abbr_region,
  levels=c( "SSA" , "EAP" ,"ECA" , "LAC" ,,"MENA" , "NA", "SA" ))

```

```{r}
# ----------------------------
# 9.1 Plot: SSA first vs last authorship trends
# ----------------------------

png(file = "STS 8--first_last_SSA.png", width = 3000, height = 1500)

ggplot(n_first_last_SSA_long, aes(x = pub_year, y = prop, color = abbr_region)) + 
  geom_line(size=3) +  
  geom_vline(xintercept = 2020, linetype = "dashed", color = "black", size = 1)+
  scale_y_continuous(limits = c(0, 0.85) ,
  breaks = seq(0, 0.85, by = 0.1) ) +
  labs( x = "Year", y = "Proportion of publication")  +  
  scale_color_manual(values = c( 
    "SSA" = "black",
    "EAP" = "#1f77b4",
    "ECA" = "#ff7f0e",
    "LAC" = "#2ca02c",
    "MENA" = "#d62728",
    "NA" = "#9467bd",
    "SA" = "#8c564b"
    
    )  ,labels=c( "SSA" = "Overall inter-SSA", "EAP" = "East Asia & Pacific",
               "ECA" = "Europe & Central Asia",
               "LAC"  = "LAC",
               "MENA" = "Middle East & North Africa",
               "NA" = "North America",
               "SA" = "South Asia"), name = "Region of collaboration") +
  facet_wrap(~ position, ncol = 2) +
  guides(color = guide_legend(nrow = 2))+
   theme_minimal() +  
   theme(strip.placement = "outside",
    axis.text.x = element_text(size = 50), # x 
    axis.text.y = element_text(size = 50),
     axis.title.x = element_text(size = 50, margin = margin(20, 0, 0, 0)),
    axis.title.y = element_text(size = 50, margin = margin(0, 20, 0, 0)),
    panel.grid.major = element_line(color = "grey80"),  
    panel.grid.minor = element_line(color = "grey80"),  #element_blank(),  
    plot.title = element_text(hjust = 0.5, vjust = 0.5, size = 50, face = "bold"),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),    
    legend.key.size = unit(3, "cm") ,
    strip.text = element_text(size = 50, face = "bold"),
    strip.background = element_blank()
  )
dev.off()
```



```{r}
# ----------------------------
# 10. Authorship positions (LAC): first vs last author shares by partner region
# ----------------------------

# Read annual shares of first/last authorship in cross-region collaborations (LAC)


n_first_last_LAC<-read.csv("percent of first and last authorship when collaborate with other regions--LAC.csv",header=T,sep=',',stringsAsFactors = FALSE,na.strings = "")

# Reshape to long format: one row per (year, region, position)

n_first_last_LAC_long <- n_first_last_LAC %>%
  pivot_longer(
    cols = c(prop_first_pub_region_year, prop_last_pub_region_year),
    names_to  = "position",
    values_to = "prop"
  ) %>%
  mutate(
    position = recode(
      position,
      prop_first_pub_region_year = "1st authorship position",
      prop_last_pub_region_year  = "Last authorship position"
    )
  )
# Set region order (legend + plotting order)

n_first_last_LAC_long$abbr_region<-factor(
  n_first_last_LAC_long$abbr_region,
  levels=c("LAC" , "EAP" ,"ECA" ,   "MENA" , "NA", "SA","SSA"  ))
```

```{r}
# ----------------------------
# 10.1 Plot: LAC first vs last authorship trends
# ----------------------------

png(file = "STS 9--first_last_LAC.png", width = 3000, height = 1500)

ggplot(n_first_last_LAC_long, aes(x = pub_year, y = prop, color = abbr_region)) + 
  geom_line(size=3) +  
  geom_vline(xintercept = 2020, linetype = "dashed", color = "black", size = 1)+
  scale_y_continuous(limits = c(0, 0.7) ,
  breaks = seq(0, 0.7, by = 0.1) ) +
  labs( x = "Year", y = "Proportion of publication")  +  
  scale_color_manual(values = c( 
    "EAP" = "#1f77b4",
    "ECA" = "#ff7f0e",
    "LAC" =  "black",
    "MENA" = "#d62728",
    "NA" = "#9467bd",
    "SA" = "#8c564b",
    "SSA" = "#e377c2"
    )  ,labels=c(  "EAP" = "East Asia & Pacific",
               "ECA" = "Europe & Central Asia",
               "LAC"  = "Overall inter-LAC",
               "MENA" = "Middle East & North Africa",
               "NA" = "North America",
               "SA" = "South Asia",
    "SSA" = "SSA"), name = "Region of collaboration") +
  facet_wrap(~ position, ncol = 2) +
  guides(color = guide_legend(nrow = 2))+
   theme_minimal() +  
   theme(strip.placement = "outside",
    axis.text.x = element_text(size = 50), # x 
    axis.text.y = element_text(size = 50),
     axis.title.x = element_text(size = 50, margin = margin(20, 0, 0, 0)),
    axis.title.y = element_text(size = 50, margin = margin(0, 20, 0, 0)),
    panel.grid.major = element_line(color = "grey80"),  
    panel.grid.minor = element_line(color = "grey80"),  #element_blank(),  
    plot.title = element_text(hjust = 0.5, vjust = 0.5, size = 50, face = "bold"),
    axis.ticks = element_line(size = 1),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "bottom",  
    legend.title = element_text(size = 50),  
    legend.text = element_text(size = 50),    
    legend.key.size = unit(3, "cm") ,
    strip.text = element_text(size = 50, face = "bold"),
    strip.background = element_blank()
  )
dev.off()

```